@page "/changelist"
@inject HttpClient Http

<PageTitle>Change List</PageTitle>

<h1>Change List</h1>
<p>Recent commits to the master branch:</p>

@if (allCommits == null)
{
    <p><em>Loading commits...</em></p>
}
else if (allCommits.Length == 0)
{
    <p>No commits found.</p>
}
else
{
    <div class="commit-list">
        @foreach (var commit in allCommits.Take(visibleCount))
        {
            <div class="commit-item card mb-2 p-2">
                <div class="commit-header">
                    <span class="commit-hash badge bg-secondary">@commit.ShortHash</span>
                    <span class="commit-date text-muted ms-2">@FormatDate(commit.Date)</span>
                </div>
                <div class="commit-message mt-1">
                    <strong>@commit.Message</strong>
                </div>
                <div class="commit-author text-muted small">
                    by @commit.Author
                </div>
            </div>
        }
    </div>

    @if (visibleCount < allCommits.Length)
    {
        <div class="mt-3">
            <button class="btn btn-outline-primary" @onclick="LoadMore">
                Load More (@(allCommits.Length - visibleCount) remaining)
            </button>
        </div>
    }
}

@code {
    private CommitInfo[]? allCommits;
    private int visibleCount = 5;
    private const int LoadIncrement = 5;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            allCommits = await Http.GetFromJsonAsync<CommitInfo[]>("changelog.json");
        }
        catch
        {
            allCommits = [];
        }
    }

    private void LoadMore()
    {
        if (allCommits != null)
        {
            visibleCount = Math.Min(visibleCount + LoadIncrement, allCommits.Length);
        }
    }

    private static string FormatDate(string dateString)
    {
        if (DateTime.TryParse(dateString, out var date))
        {
            return date.ToString("yyyy-MM-dd HH:mm");
        }
        return dateString;
    }

    private class CommitInfo
    {
        public string Hash { get; set; } = "";
        public string ShortHash { get; set; } = "";
        public string Date { get; set; } = "";
        public string Author { get; set; } = "";
        public string Message { get; set; } = "";
    }
}
