@page "/ftpbattle"
@using AbeGaming.GameLogic
@using AbeGaming.GameLogic.FtP
@inject IJSRuntime JS

<PageTitle>FtP Battle Calculator</PageTitle>

<h1 class="h3 mb-3">For The People - Battle Calculator</h1>

@* Compact Battle Location *@
<div class="card mb-2">
    <div class="card-body py-2">
        <div class="d-flex flex-wrap gap-3">
            <div class="form-check form-check-inline mb-0">
                <input class="form-check-input" type="checkbox" id="resourceOrCapital" @bind="ResourceOrCapital" />
                <label class="form-check-label small" for="resourceOrCapital">
                    Resource/Capital
                    <InfoTip Text="No Star results when attacking a Resource or Capital" />
                </label>
            </div>
            <div class="form-check form-check-inline mb-0">
                <input class="form-check-input" type="checkbox" id="fortPresent" @bind="FortPresent" />
                <label class="form-check-label small" for="fortPresent">
                    Fort
                    <InfoTip Text="Defender gets +2 DRM. Prevents Overrun." />
                </label>
            </div>
            <div class="form-check form-check-inline mb-0">
                <input class="form-check-input" type="checkbox" id="isInterception" @bind="IsInterception" />
                <label class="form-check-label small" for="isInterception">
                    Interception
                    <InfoTip Text="Defender gets +2 DRM when intercepting" />
                </label>
            </div>
            <div class="form-check form-check-inline mb-0">
                <input class="form-check-input" type="checkbox" id="isDefenderLeaderPresent" @bind="IsDefenderLeaderPresent" />
                <label class="form-check-label small" for="isDefenderLeaderPresent">
                    Def. Leader
                    <InfoTip Text="For attacker continuation logic. Leader death is always calculated assuming leaders are present." />
                </label>
            </div>
        </div>
    </div>
</div>

@* Compact Attacker/Defender side-by-side *@
<div class="row g-2 mb-2">
    <div class="col-6">
        <FtpSideInput SideName="Attacker"
                      Icon="ğŸ—¡ï¸"
                      HeaderColor="primary"
                      SpInfoTip="Strength Points attacking"
                      OosInfoTip="Out of Supply: Defender gets +2 DRM"
                      OosCheckboxId="attackerOOS"
                      MinSize="1"
                      MaxSize="15"
                      @bind-Size="AttackerSize"
                      @bind-DRM="AttackerLeadersDRMIncludingCavalryIntelligence"
                      @bind-Elites="AttackerElitesCommitted"
                      @bind-OOS="AttackerOOS" />
    </div>
    <div class="col-6">
        <FtpSideInput SideName="Defender"
                      Icon="ğŸ›¡ï¸"
                      HeaderColor="danger"
                      SpInfoTip="Strength Points defending"
                      OosInfoTip="Out of Supply: Attacker gets +2 DRM"
                      OosCheckboxId="defenderOOS"
                      MinSize="@(IsAmphibious ? 0 : 1)"
                      MaxSize="30"
                      @bind-Size="DefenderSize"
                      @bind-DRM="DefenderLeadersDRMIncludingCavalryIntelligence"
                      @bind-Elites="DefenderElitesCommitted"
                      @bind-OOS="DefenderOOS" />
    </div>
</div>

@* Show Overrun warning if applicable *@
@if (CurrentBattle.IsOverrun())
{
    <div class="alert alert-danger py-2 mb-2">
        <strong>ğŸ’¥OVERRUN!</strong> 10:1+ ratio with no Fort - Defender is automatically eliminated.
    </div>
}

@* Action Buttons - Exact Stats is primary *@
<div class="d-grid gap-2 mb-3">
    <button class="btn btn-primary btn-lg" @onclick="CalculateExactStats">
        ğŸ“ˆCalculate Exact Stats
    </button>
    <div class="btn-group" role="group">
        <button class="btn btn-secondary" @onclick="CalculateBattleResult">
            ğŸ²Roll 1 Battle
        </button>
        <button class="btn btn-outline-secondary" @onclick="RunMonteCarloTrials" disabled="@IsRunning">
            @if (IsRunning)
            {
                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                <span>Running...</span>
            }
            else
            {
                <span>ğŸ²MC @Trials.ToString("N0")</span>
            }
        </button>
    </div>
</div>

@* Results Section *@
<div id="resultsSection">
    @if (ExactStats != null)
    {
        <FtpStatsDisplay Stats="ExactStats"
                         Title="@($"ğŸ“ˆExact Stats ({ExactStats.BattleSize})")"
                         BorderColor="primary"
                         HeaderBgColor="primary"
                         ShowStdDev="true"
                         AttackerElitesCommitted="AttackerElitesCommitted"
                         DefenderElitesCommitted="DefenderElitesCommitted" />
    }

    @if (MonteCarloResult != null)
    {
        <FtpStatsDisplay Stats="MonteCarloResult.Value.result"
                         Title="@($"ğŸ“ŠMonte Carlo ({MonteCarloResult.Value.trials:N0} trials)")"
                         BorderColor="info"
                         HeaderBgColor="info"
                         ShowStdDev="false"
                         AttackerElitesCommitted="AttackerElitesCommitted"
                         DefenderElitesCommitted="DefenderElitesCommitted" />
    }

    @if (BattleResult != null)
    {
        <div class="card @GetResultCardClass() mb-3">
            <div class="card-header py-2">
                <strong>Single Battle Result</strong>
            </div>
            <div class="card-body py-2">
                <div class="row">
                    <div class="col-6">
                        <p class="fs-5 fw-bold mb-1">
                            @if (BattleResult.Winner == Winner.Attacker)
                            {
                                <span class="text-success">ğŸ—¡ï¸Attacker Wins!</span>
                            }
                            else
                            {
                                <span class="text-danger">ğŸ›¡ï¸Defender Wins!</span>
                            }
                        </p>
                        @if (BattleResult.Overrun)
                        {
                            <span class="badge bg-danger">ğŸ’¥Overrun!</span>
                        }
                        @if (BattleResult.Star)
                        {
                            <span class="badge bg-warning text-dark">â­Star</span>
                        }
                    </div>
                    <div class="col-6 small">
                        <div>ğŸ²Att. @BattleResult.AttackerDieRoll | ğŸ²Def. @BattleResult.DefenderDieRoll</div>
                        <div>
                            ğŸ—¡ï¸Att. -@BattleResult.DamageToAttacker SP
                            @if (BattleResult.DamageToAttacker >= LastAttackerSize)
                            {
                                <span class="text-danger">(Wiped out!)</span>
                            }
                            @if (BattleResult.AttackerEliteLoss)
                            {
                                <span class="badge bg-warning text-dark ms-1">ğŸ–ï¸Elite Lost</span>
                            }
                        </div>
                        <div>
                            ğŸ›¡ï¸Def. -@BattleResult.DamageToDefender SP
                            @if (LastDefenderSize > 0 && BattleResult.DamageToDefender >= LastDefenderSize)
                            {
                                <span class="text-danger">(Wiped out!)</span>
                            }
                            @if (BattleResult.DefenderEliteLoss)
                            {
                                <span class="badge bg-warning text-dark ms-1">ğŸ–ï¸Elite Lost</span>
                            }
                        </div>
                    </div>
                </div>
                @if (BattleResult.AttackerLeaderDeathDieRoll.HasValue || BattleResult.DefenderLeaderDeathDieRoll.HasValue)
                {
                    <hr class="my-1" />
                    <div class="small">
                        @if (BattleResult.AttackerLeaderDeathDieRoll.HasValue)
                        {
                            <span class="me-2">
                                Att.LeaderğŸ’€: <span class="@(BattleResult.AttackerLeaderDeath ? "text-danger" : "text-success")">@(BattleResult.AttackerLeaderDeath ? "Dead" : "Safe")</span> (rolled @BattleResult.AttackerLeaderDeathDieRoll)
                            </span>
                        }
                        @if (BattleResult.DefenderLeaderDeathDieRoll.HasValue)
                        {
                            <span>
                                Def.LeaderğŸ’€: <span class="@(BattleResult.DefenderLeaderDeath ? "text-danger" : "text-success")">@(BattleResult.DefenderLeaderDeath ? "Dead" : "Safe")</span> (rolled @BattleResult.DefenderLeaderDeathDieRoll)
                            </span>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@* Trials slider in a collapsible section *@
<details class="mt-3">
    <summary class="text-muted small">Monte Carlo Settings</summary>
    <div class="mt-2">
        <label class="form-label small">Trials: 2<sup>@TrialsExponent</sup> = @Trials.ToString("N0")</label>
        <input type="range" class="form-range" @bind="TrialsExponent" @bind:event="oninput" min="13" max="20" />
    </div>
</details>

@code {
    // Battle Location
    private bool ResourceOrCapital;
    private bool FortPresent;
    private bool IsInterception;
    private bool IsDefenderLeaderPresent;
    private bool IsAmphibious = false;

    // Attacker (with clamped setters)
    private int _attackerSize = 5;
    private int AttackerSize
    {
        get => _attackerSize;
        set => _attackerSize = Math.Clamp(value, 1, 15);
    }

    private int _attackerDRM = 0;
    private int AttackerLeadersDRMIncludingCavalryIntelligence
    {
        get => _attackerDRM;
        set => _attackerDRM = Math.Clamp(value, 0, 9);
    }

    private int _attackerElites = 0;
    private int AttackerElitesCommitted
    {
        get => _attackerElites;
        set => _attackerElites = Math.Clamp(value, 0, 2);
    }

    private bool AttackerOOS;

    // Defender (with clamped setters)
    private int _defenderSize = 5;
    private int DefenderSize
    {
        get => _defenderSize;
        set => _defenderSize = Math.Clamp(value, IsAmphibious ? 0 : 1, 30);
    }

    private int _defenderDRM = 0;
    private int DefenderLeadersDRMIncludingCavalryIntelligence
    {
        get => _defenderDRM;
        set => _defenderDRM = Math.Clamp(value, 0, 9);
    }

    private int _defenderElites = 0;
    private int DefenderElitesCommitted
    {
        get => _defenderElites;
        set => _defenderElites = Math.Clamp(value, 0, 2);
    }

    private bool DefenderOOS;

    // Single Battle Result
    private FTPBattleResult? BattleResult;

    // Monte Carlo
    private (int trials, FtpStats result)? MonteCarloResult;
    private FtpBattle? LastMonteCarloBattle;
    private bool IsRunning;
    private int TrialsExponent = 15; // 2^15 = 32,768 as default
    private int Trials => 1 << TrialsExponent; // 2^exponent

    // Exact Stats
    private FtpStats? ExactStats;
    private FtpBattle? LastExactStatsBattle;

    // Store sizes at time of calculation for "Wiped Out!" display
    private int LastAttackerSize;
    private int LastDefenderSize;

    // Current battle for live calculations (e.g., IsOverrun check)
    private FtpBattle CurrentBattle => CreateBattle();

    private FtpBattle CreateBattle() => new FtpBattle(
        ResourceOrCapital,
        FortPresent,
        IsInterception,
        IsDefenderLeaderPresent,
        AttackerSize,
        DefenderSize,
        AttackerLeadersDRMIncludingCavalryIntelligence,
        DefenderLeadersDRMIncludingCavalryIntelligence,
        AttackerElitesCommitted,
        DefenderElitesCommitted,
        AttackerOOS,
        DefenderOOS,
        IsAmphibious);

    private async Task ScrollToResults()
    {
        await JS.InvokeVoidAsync("eval", "document.getElementById('resultsSection')?.scrollIntoView({behavior: 'smooth'})");
    }

    private async Task CalculateBattleResult()
    {
        LastAttackerSize = AttackerSize;
        LastDefenderSize = DefenderSize;
        BattleResult = CreateBattle().BattleResult(Dice.RollOneDieRepeatedly(4));
        await ScrollToResults();
    }

    private async Task RunMonteCarloTrials()
    {
        FtpBattle battle = CreateBattle();
        BattleResult = null;

        // Clear stale ExactStats only if battle has changed
        if (LastExactStatsBattle != null && LastExactStatsBattle != battle)
        {
            ExactStats = null;
            LastExactStatsBattle = null;
        }

        IsRunning = true;
        StateHasChanged();

        MonteCarloResult = await Task.Run(() => FtpMonteCarlo.Run(battle, TrialsExponent));
        LastMonteCarloBattle = battle;

        IsRunning = false;
        StateHasChanged();
        await ScrollToResults();
    }

    private async Task CalculateExactStats()
    {
        FtpBattle battle = CreateBattle();
        BattleResult = null;

        // Clear stale MonteCarloResult only if battle has changed
        if (LastMonteCarloBattle != null && LastMonteCarloBattle != battle)
        {
            MonteCarloResult = null;
            LastMonteCarloBattle = null;
        }

        ExactStats = battle.ExactStats();
        LastExactStatsBattle = battle;
        await ScrollToResults();
    }

    private string GetResultCardClass()
    {
        if (BattleResult == null) return "";

        return BattleResult.Winner switch
        {
            Winner.Attacker => "border-success",
            Winner.Defender => "border-danger",
            _ => "border-warning"
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Select all text in number inputs on focus (helps mobile users)
            await JS.InvokeVoidAsync("eval", @"
                document.querySelectorAll('input[type=""number""]').forEach(input => {
                    input.addEventListener('focus', function() { this.select(); });
                });
            ");
        }
    }
}
