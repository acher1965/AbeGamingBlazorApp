@page "/ftpbattle"
@using AbeGaming.GameLogic
@using AbeGaming.GameLogic.FtP

<PageTitle>FtP Battle Calculator</PageTitle>

<h1>For The People - Battle Calculator</h1>
<div class="row">
    <div class="col-md-6">
        <h4>Battle Location</h4>
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="resourceOrCapital" @bind="ResourceOrCapital" />
            <label class="form-check-label" for="resourceOrCapital">Resource or Capital</label>
        </div>
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="fortPresent" @bind="FortPresent" />
            <label class="form-check-label" for="fortPresent">Fort Present</label>
        </div>
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="isInterception" @bind="IsInterception" />
            <label class="form-check-label" for="isInterception">Is Interception</label>
        </div>
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="isDefenderLeaderPresent" @bind="IsDefenderLeaderPresent" />
            <label class="form-check-label" for="isDefenderLeaderPresent">Defender Leader Present</label>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <h4>Attacker</h4>
        <div class="mb-3">
            <label for="attackerSize" class="form-label">Attacker Size: <strong>@AttackerSize</strong> SP</label>
            <input type="range" class="form-range" id="attackerSize" @bind="AttackerSize" @bind:event="oninput" min="1" max="15" />
        </div>
        <div class="mb-3">
            <label for="attackerLeaderDRM" class="form-label">Attacker Leader DRM: <strong>@AttackerLeadersDRMIncludingCavalryIntelligence</strong></label>
            <input type="range" class="form-range" id="attackerLeaderDRM" @bind="AttackerLeadersDRMIncludingCavalryIntelligence" @bind:event="oninput" min="0" max="9" />
        </div>
        <div class="mb-3">
            <label for="attackerElites" class="form-label">Attacker Elites Committed: <strong>@AttackerElitesCommitted</strong></label>
            <input type="range" class="form-range" id="attackerElites" @bind="AttackerElitesCommitted" @bind:event="oninput" min="0" max="2" />
        </div>
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="attackerOOS" @bind="AttackerOOS" />
            <label class="form-check-label" for="attackerOOS">Attacker Out of Supply</label>
        </div>
    </div>

    <div class="col-md-6">
        <h4>Defender</h4>
        <div class="mb-3">
            <label for="defenderSize" class="form-label">Defender Size: <strong>@DefenderSize</strong> SP</label>
            <input type="range" class="form-range" id="defenderSize" @bind="DefenderSize" @bind:event="oninput" min="@(IsAmphibious ? 0 : 1)" max="30" />
        </div>
        <div class="mb-3">
            <label for="defenderLeaderDRM" class="form-label">Defender Leader DRM: <strong>@DefenderLeadersDRMIncludingCavalryIntelligence</strong></label>
            <input type="range" class="form-range" id="defenderLeaderDRM" @bind="DefenderLeadersDRMIncludingCavalryIntelligence" @bind:event="oninput" min="0" max="9" />
        </div>
        <div class="mb-3">
            <label for="defenderElites" class="form-label">Defender Elites Committed: <strong>@DefenderElitesCommitted</strong></label>
            <input type="range" class="form-range" id="defenderElites" @bind="DefenderElitesCommitted" @bind:event="oninput" min="0" max="2" />
        </div>
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="defenderOOS" @bind="DefenderOOS" />
            <label class="form-check-label" for="defenderOOS">Defender Out of Supply</label>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col">
        <button class="btn btn-primary btn-lg me-2" @onclick="CalculateBattleResult">Get Single Battle Result</button>
        <button class="btn btn-outline-secondary btn-lg" @onclick="RunMonteCarloTrials" disabled="@IsRunning">
            @if (IsRunning)
            {
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                <span>Running...</span>
            }
            else
            {
                <span>üìä Run @Trials.ToString("N0") Trials</span>
            }
        </button>
        <button class="btn btn-outline-info btn-lg" @onclick="CalculateExactStats">
            üìà Calculate Exact Stats
        </button>
    </div>
</div>

<div class="row mt-2">
    <div class="col-md-6">
        <label for="trials" class="form-label">Trials: <strong>2<sup>@TrialsExponent</sup> = @Trials.ToString("N0")</strong></label>
        <input type="range" class="form-range" id="trials" @bind="TrialsExponent" @bind:event="oninput" min="13" max="20" />
        <small class="text-muted">8,192 to 1,048,576 (powers of 2 for better performance)</small>
    </div>
</div>

@if (ExactStats != null)
{
    <div class="row mt-4">
        <div class="col">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">üìà Exact Statistics (@ExactStats.BattleSize battle)</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h5>Win Probabilities</h5>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Attacker Wins:</span>
                                    <strong class="text-success">@(ExactStats.AttackerWinProbability.ToString("P1"))</strong>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" role="progressbar"
                                         style="width: @(ExactStats.AttackerWinProbability * 100)%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Defender Wins:</span>
                                    <strong class="text-danger">@(ExactStats.DefenderWinProbability.ToString("P1"))</strong>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-danger" role="progressbar"
                                         style="width: @(ExactStats.DefenderWinProbability * 100)%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h5>Expected Casualties</h5>
                            <p>
                                <strong>Attacker:</strong>
                                @(ExactStats.HitsStats.MeanHtoA.ToString("F1")) SP
                                <small class="text-muted">(¬±@(ExactStats.HitsStats.StdDevHtoA.ToString("F1")))</small>
                            </p>
                            <p>
                                <strong>Defender:</strong>
                                @(ExactStats.HitsStats.MeanHtoD.ToString("F1")) SP
                                <small class="text-muted">(¬±@(ExactStats.HitsStats.StdDevHtoD.ToString("F1")))</small>
                            </p>
                        </div>
                        <div class="col-md-4">
                            <h5>Special Outcomes</h5>
                            <p>
                                <strong>‚≠ê Star Result:</strong>
                                @(ExactStats.StarResultProbability.ToString("P1"))
                            </p>
                            @if (ExactStats.AttackerLeaderDeathProbability > 0 || ExactStats.DefenderLeaderDeathProbability > 0)
                            {
                                <p>
                                    <strong>‚ò†Ô∏è Attacker Leader Death:</strong>
                                    @(ExactStats.AttackerLeaderDeathProbability.ToString("P1"))
                                </p>
                                <p>
                                    <strong>‚ò†Ô∏è Defender Leader Death:</strong>
                                    @(ExactStats.DefenderLeaderDeathProbability.ToString("P1"))
                                </p>
                            }
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>Attacker Losses Distribution</h6>
                            <table class="table table-sm table-bordered mb-0" style="font-size: 0.85em;">
                                <thead class="table-light">
                                    <tr>
                                        @foreach (var kvp in ExactStats.HitsStats.HitsToA_Prblty.OrderBy(x => x.Key))
                                        {
                                            <th class="text-center px-1">@kvp.Key</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        @foreach (var kvp in ExactStats.HitsStats.HitsToA_Prblty.OrderBy(x => x.Key))
                                        {
                                            <td class="text-center px-1">@(kvp.Value.ToString("P1"))</td>
                                        }
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Defender Losses Distribution</h6>
                            <table class="table table-sm table-bordered mb-0" style="font-size: 0.85em;">
                                <thead class="table-light">
                                    <tr>
                                        @foreach (var kvp in ExactStats.HitsStats.HitsToD_Prblty.OrderBy(x => x.Key))
                                        {
                                            <th class="text-center px-1">@kvp.Key</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        @foreach (var kvp in ExactStats.HitsStats.HitsToD_Prblty.OrderBy(x => x.Key))
                                        {
                                            <td class="text-center px-1">@(kvp.Value.ToString("P1"))</td>
                                        }
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (MonteCarloResult != null)
{
    <div class="row mt-4">
        <div class="col">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">üìä Monte Carlo Results (@MonteCarloResult.Value.trials.ToString("N0") trials, @MonteCarloResult.Value.result.BattleSize battle)</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h5>Win Probabilities</h5>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Attacker Wins:</span>
                                    <strong class="text-success">@(MonteCarloResult.Value.result.AttackerWinProbability.ToString("P1"))</strong>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" role="progressbar"
                                         style="width: @(MonteCarloResult.Value.result.AttackerWinProbability * 100)%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Defender Wins:</span>
                                    <strong class="text-danger">@(MonteCarloResult.Value.result.DefenderWinProbability.ToString("P1"))</strong>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-danger" role="progressbar"
                                         style="width: @(MonteCarloResult.Value.result.DefenderWinProbability * 100)%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h5>Expected Casualties</h5>
                            <p>
                                <strong>Attacker:</strong>
                                @(MonteCarloResult.Value.result.HitsStats.MeanHtoA.ToString("F1")) SP
                                <small class="text-muted">(¬±@(MonteCarloResult.Value.result.HitsStats.StdDevHtoA.ToString("F1")))</small>
                            </p>
                            <p>
                                <strong>Defender:</strong>
                                @(MonteCarloResult.Value.result.HitsStats.MeanHtoD.ToString("F1")) SP
                                <small class="text-muted">(¬±@(MonteCarloResult.Value.result.HitsStats.StdDevHtoD.ToString("F1")))</small>
                            </p>
                        </div>
                        <div class="col-md-4">
                            <h5>Special Outcomes</h5>
                            <p>
                                <strong>‚≠ê Star Result:</strong>
                                @(MonteCarloResult.Value.result.StarResultProbability.ToString("P1"))
                            </p>
                            @if (MonteCarloResult.Value.result.AttackerLeaderDeathProbability > 0 || MonteCarloResult.Value.result.DefenderLeaderDeathProbability > 0)
                            {
                                <p>
                                    <strong>‚ò†Ô∏è Attacker Leader Death:</strong>
                                    @(MonteCarloResult.Value.result.AttackerLeaderDeathProbability.ToString("P1"))
                                </p>
                                <p>
                                    <strong>‚ò†Ô∏è Defender Leader Death:</strong>
                                    @(MonteCarloResult.Value.result.DefenderLeaderDeathProbability.ToString("P1"))
                                </p>
                            }
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>Attacker Losses Distribution</h6>
                            <table class="table table-sm table-bordered mb-0" style="font-size: 0.85em;">
                                <thead class="table-light">
                                    <tr>
                                        @foreach (var kv in MonteCarloResult.Value.result.HitsStats.HitsToA_Prblty)
                                        {
                                            <th class="text-center px-1">@kv.Key</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        @foreach (var kv in MonteCarloResult.Value.result.HitsStats.HitsToA_Prblty)
                                        {
                                            <td class="text-center px-1">@(kv.Value.ToString("P1"))</td>
                                        }
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Defender Losses Distribution</h6>
                            <table class="table table-sm table-bordered mb-0" style="font-size: 0.85em;">
                                <thead class="table-light">
                                    <tr>
                                        @foreach (var kv in MonteCarloResult.Value.result.HitsStats.HitsToD_Prblty)
                                        {
                                            <th class="text-center px-1">@kv.Key</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        @foreach (var kv in MonteCarloResult.Value.result.HitsStats.HitsToD_Prblty)
                                        {
                                            <td class="text-center px-1">@(kv.Value.ToString("P1"))</td>
                                        }
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (BattleResult != null)
{
    <div class="row mt-4">
        <div class="col">
            <div class="card @GetResultCardClass()">
                <div class="card-header">
                    <h4 class="mb-0">Battle Result</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Outcome</h5>
                            <p class="fs-4 fw-bold">
                                @if (BattleResult.Winner == Winner.Attacker)
                                {
                                    <span class="text-success">üèÜ Attacker Wins!</span>
                                    @if (BattleResult.Overrun)
                                    {
                                        <br />
                                        <span class="text-danger">Overrun!</span>
                                    }
                                }
                                else if (BattleResult.Winner == Winner.Defender)
                                {
                                    <span class="text-danger">üõ°Ô∏è Defender Wins!</span>
                                }
                                else
                                {
                                    <span class="text-warning">‚öñÔ∏è Draw</span>
                                }
                            </p>
                            <p><strong>Battle Size:</strong> @BattleResult.BattleSize</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Dice Rolled</h5>
                            <p><strong>Attacker Die:</strong> üé≤ @BattleResult.AttackerDieRoll</p>
                            <p><strong>Defender Die:</strong> üé≤ @BattleResult.DefenderDieRoll</p>
                            <p>
                                <strong>Star Result:</strong>
                                @if (BattleResult.Star)
                                {
                                    <span class="text-warning">‚≠ê Yes</span>
                                }
                                else
                                {
                                    <span>No</span>
                                }
                            </p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h5>Casualties</h5>
                            <p>
                                <strong>Damage to Attacker:</strong>
                                @if (BattleResult.DamageToAttacker >= LastAttackerSize)
                                {
                                    <span class="text-danger fw-bold">Wiped Out!</span>
                                }
                                else
                                {
                                    <span>@BattleResult.DamageToAttacker SP</span>
                                }
                            </p>
                            <p>
                                <strong>Damage to Defender:</strong>
                                @if (LastDefenderSize > 0 && BattleResult.DamageToDefender >= LastDefenderSize)
                                {
                                    <span class="text-danger fw-bold">Wiped Out!</span>
                                }
                                else
                                {
                                    <span>@BattleResult.DamageToDefender SP</span>
                                }
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h5>Leader Casualties</h5>
                            <p>
                                <strong>Attacker Leader:</strong>
                                @if (BattleResult.AttackerLeaderDeathDieRoll.HasValue)
                                {
                                    if (BattleResult.AttackerLeaderDeath)
                                    {
                                        <span class="text-danger">‚ò†Ô∏è Killed (rolled üé≤ @BattleResult.AttackerLeaderDeathDieRoll)</span>
                                    }
                                    else
                                    {
                                        <span class="text-success">‚úì Survived (rolled üé≤ @BattleResult.AttackerLeaderDeathDieRoll)</span>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">No risk</span>
                                }
                            </p>
                            <p>
                                <strong>Defender Leader:</strong>
                                @if (BattleResult.DefenderLeaderDeathDieRoll.HasValue)
                                {
                                    if (BattleResult.DefenderLeaderDeath)
                                    {
                                        <span class="text-danger">‚ò†Ô∏è Killed (rolled üé≤ @BattleResult.DefenderLeaderDeathDieRoll)</span>
                                    }
                                    else
                                    {
                                        <span class="text-success">‚úì Survived (rolled üé≤ @BattleResult.DefenderLeaderDeathDieRoll)</span>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">No risk</span>
                                }
                            </p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col">
                            <h5>Movement</h5>
                            <p>
                                <strong>Attacker Can Stay:</strong>
                                @(BattleResult.AttackerCanStay ? "Yes ‚úì" : "No ‚úó")
                            </p>
                            <p>
                                <strong>Attacker Can Continue Moving:</strong>
                                @(BattleResult.AttackerCanContinueMoving ? "Yes ‚úì" : "No ‚úó")
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // Battle Location
    private bool ResourceOrCapital;
    private bool FortPresent;
    private bool IsInterception;
    private bool IsDefenderLeaderPresent;
    private bool IsAmphibious = false;

    // Attacker
    private int AttackerSize = 5;
    private int AttackerLeadersDRMIncludingCavalryIntelligence = 0;
    private int AttackerElitesCommitted = 0;
    private bool AttackerOOS;

    // Defender
    private int DefenderSize = 5;
    private int DefenderLeadersDRMIncludingCavalryIntelligence = 0;
    private int DefenderElitesCommitted = 0;
    private bool DefenderOOS;

    // Result
    private FTPBattleResult? BattleResult;

    // Monte Carlo
    private (int trials, FtpStats result)? MonteCarloResult;
    private bool IsRunning;
    private int TrialsExponent = 15; // 2^15 = 32,768 as default
    private int Trials => 1 << TrialsExponent; // 2^exponent

    // Exact Stats
    private FtpStats? ExactStats;

    // Store sizes at time of calculation for "Wiped Out!" display
    private int LastAttackerSize;
    private int LastDefenderSize;

    private FtpBattle CreateBattle() => new FtpBattle(
        ResourceOrCapital,
        FortPresent,
        IsInterception,
        IsDefenderLeaderPresent,
        AttackerSize,
        DefenderSize,
        AttackerLeadersDRMIncludingCavalryIntelligence,
        DefenderLeadersDRMIncludingCavalryIntelligence,
        AttackerElitesCommitted,
        DefenderElitesCommitted,
        AttackerOOS,
        DefenderOOS,
        IsAmphibious);

    private void CalculateBattleResult()
    {
        // Range sliders automatically enforce min/max, no clamping needed
        LastAttackerSize = AttackerSize;
        LastDefenderSize = DefenderSize;

        BattleResult = CreateBattle().BattleResult(Dice.RollOneDieRepeatedly(4));
    }

    private async Task RunMonteCarloTrials()
    {
        IsRunning = true;
        StateHasChanged();

        // Run trials on a background thread to keep UI responsive
        FtpBattle battle = CreateBattle();
        MonteCarloResult = await Task.Run(() => FtpMonteCarlo.Run(battle, TrialsExponent));

        IsRunning = false;
        StateHasChanged();
    }

    private void CalculateExactStats()
    {
        ExactStats = CreateBattle().ExactStats();
    }

    private string GetResultCardClass()
    {
        if (BattleResult == null) return "";

        return BattleResult.Winner switch
        {
            Winner.Attacker => "border-success",
            Winner.Defender => "border-danger",
            _ => "border-warning"
        };
    }
}
