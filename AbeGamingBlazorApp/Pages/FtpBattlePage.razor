@page "/ftpbattle"
@using AbeGaming.GameLogic
@using AbeGaming.GameLogic.FtP
@inject IJSRuntime JS

<PageTitle>FtP Battle Calculator</PageTitle>

<h1 class="h3 mb-3">For The People - Battle Calculator</h1>

@* Compact Battle Location *@
<div class="card mb-2">
    <div class="card-body py-2">
        <div class="d-flex flex-wrap gap-3">
            <div class="form-check form-check-inline mb-0">
                <input class="form-check-input" type="checkbox" id="resourceOrCapital" @bind="ResourceOrCapital" />
                <label class="form-check-label small" for="resourceOrCapital">
                    Resource/Capital
                    <InfoTip Text="No Star results when attacking a Resource or Capital" />
                </label>
            </div>
            <div class="form-check form-check-inline mb-0">
                <input class="form-check-input" type="checkbox" id="fortPresent" @bind="FortPresent" />
                <label class="form-check-label small" for="fortPresent">
                    Fort
                    <InfoTip Text="Defender gets +2 DRM. Prevents Overrun." />
                </label>
            </div>
            <div class="form-check form-check-inline mb-0">
                <input class="form-check-input" type="checkbox" id="isInterception" @bind="IsInterception" />
                <label class="form-check-label small" for="isInterception">
                    Interception
                    <InfoTip Text="Defender gets +2 DRM when intercepting" />
                </label>
            </div>
            <div class="form-check form-check-inline mb-0">
                <input class="form-check-input" type="checkbox" id="isDefenderLeaderPresent" @bind="IsDefenderLeaderPresent" />
                <label class="form-check-label small" for="isDefenderLeaderPresent">
                    Def. Leader
                    <InfoTip Text="For attacker continuation logic. Leader death (â˜ ï¸) is always calculated assuming leaders are present." />
                </label>
            </div>
        </div>
    </div>
</div>

@* Compact Attacker/Defender side-by-side *@
<div class="row g-2 mb-2">
    <div class="col-6">
        <div class="card h-100">
            <div class="card-header py-1 bg-primary text-white">
                <strong class="small">âš”ï¸ Attacker</strong>
            </div>
            <div class="card-body py-2">
                <div class="row g-1 mb-1">
                    <label class="col-5 col-form-label col-form-label-sm">
                        SP <InfoTip Text="Strength Points attacking" />
                    </label>
                    <div class="col-7">
                        <input type="number" class="form-control form-control-sm" @bind="AttackerSize" min="1" max="15" />
                    </div>
                </div>
                <div class="row g-1 mb-1">
                    <label class="col-5 col-form-label col-form-label-sm">
                        DRM <InfoTip Text="Die Roll Modifier from Leaders and Cards. â˜ ï¸ = Leader death risk." />
                    </label>
                    <div class="col-7">
                        <input type="number" class="form-control form-control-sm" @bind="AttackerLeadersDRMIncludingCavalryIntelligence" min="0" max="9" />
                    </div>
                </div>
                <div class="row g-1 mb-1">
                    <label class="col-5 col-form-label col-form-label-sm">
                        Elites ðŸŽ–ï¸ <InfoTip Text="Elite units committed (max 2). Each gives +1 DRM. ðŸŽ–ï¸ = Elite loss risk." />
                    </label>
                    <div class="col-7">
                        <input type="number" class="form-control form-control-sm" @bind="AttackerElitesCommitted" min="0" max="2" />
                    </div>
                </div>
                <div class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="checkbox" id="attackerOOS" @bind="AttackerOOS" />
                    <label class="form-check-label small" for="attackerOOS">
                        OOS <InfoTip Text="Out of Supply: Defender gets +2 DRM" />
                    </label>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6">
        <div class="card h-100">
            <div class="card-header py-1 bg-danger text-white">
                <strong class="small">ðŸ›¡ï¸ Defender</strong>
            </div>
            <div class="card-body py-2">
                <div class="row g-1 mb-1">
                    <label class="col-5 col-form-label col-form-label-sm">
                        SP <InfoTip Text="Strength Points defending" />
                    </label>
                    <div class="col-7">
                        <input type="number" class="form-control form-control-sm" @bind="DefenderSize" min="@(IsAmphibious ? 0 : 1)" max="30" />
                    </div>
                </div>
                <div class="row g-1 mb-1">
                    <label class="col-5 col-form-label col-form-label-sm">
                        DRM <InfoTip Text="Die Roll Modifier from Leaders and Cards. â˜ ï¸ = Leader death risk." />
                    </label>
                    <div class="col-7">
                        <input type="number" class="form-control form-control-sm" @bind="DefenderLeadersDRMIncludingCavalryIntelligence" min="0" max="9" />
                    </div>
                </div>
                <div class="row g-1 mb-1">
                    <label class="col-5 col-form-label col-form-label-sm">
                        Elites ðŸŽ–ï¸ <InfoTip Text="Elite units committed (max 2). Each gives +1 DRM. ðŸŽ–ï¸ = Elite loss risk." />
                    </label>
                    <div class="col-7">
                        <input type="number" class="form-control form-control-sm" @bind="DefenderElitesCommitted" min="0" max="2" />
                    </div>
                </div>
                <div class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="checkbox" id="defenderOOS" @bind="DefenderOOS" />
                    <label class="form-check-label small" for="defenderOOS">
                        OOS <InfoTip Text="Out of Supply: Attacker gets +2 DRM" />
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

@* Show Overrun warning if applicable *@
@if (CurrentBattle.IsOverrun())
{
    <div class="alert alert-danger py-2 mb-2">
        <strong>âš ï¸ OVERRUN!</strong> 10:1+ ratio with no Fort â€” Defender is automatically eliminated.
    </div>
}

@* Action Buttons - Exact Stats is primary *@
<div class="d-grid gap-2 mb-3">
    <button class="btn btn-primary btn-lg" @onclick="CalculateExactStats">
        ðŸ“ˆ Calculate Exact Stats
    </button>
    <div class="btn-group" role="group">
        <button class="btn btn-secondary" @onclick="CalculateBattleResult">
            ðŸŽ² ðŸŽ² Roll 1 Battle
        </button>
        <button class="btn btn-outline-secondary" @onclick="RunMonteCarloTrials" disabled="@IsRunning">
            @if (IsRunning)
            {
                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                <span>Running...</span>
            }
            else
            {
                <span>ðŸ“Š MC @Trials.ToString("N0")</span>
            }
        </button>
    </div>
</div>

@* Results Section *@
<div id="resultsSection">
    @if (ExactStats != null)
    {
        <div class="card border-primary mb-3">
            <div class="card-header bg-primary text-white py-2">
                <strong>ðŸ“ˆ Exact Stats (@ExactStats.BattleSize)</strong>
            </div>
            <div class="card-body py-2">
                <div class="row g-2">
                    <div class="col-6">
                        <div class="d-flex justify-content-between small">
                            <span>âš”ï¸ Wins:</span>
                            <strong class="text-success">@(ExactStats.AttackerWinProbability.ToString("P1"))</strong>
                        </div>
                        <div class="progress mb-1" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: @(ExactStats.AttackerWinProbability * 100)%"></div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex justify-content-between small">
                            <span>ðŸ›¡ï¸ Wins:</span>
                            <strong class="text-danger">@(ExactStats.DefenderWinProbability.ToString("P1"))</strong>
                        </div>
                        <div class="progress mb-1" style="height: 8px;">
                            <div class="progress-bar bg-danger" style="width: @(ExactStats.DefenderWinProbability * 100)%"></div>
                        </div>
                    </div>
                </div>
                <hr class="my-2" />
                <div class="row small">
                    <div class="col-6">
                        <strong>âš”ï¸ Losses:</strong> @(ExactStats.HitsStats.MeanHtoA.ToString("F1")) <span class="text-muted">(Â±@(ExactStats.HitsStats.StdDevHtoA.ToString("F1")))</span>
                        @if (AttackerElitesCommitted > 0)
                        {
                            <br /><span>ðŸŽ–ï¸ Elite Loss: @(ExactStats.AttackerEliteLossProbability.ToString("P1"))</span>
                        }
                    </div>
                    <div class="col-6">
                        <strong>ðŸ›¡ï¸ Losses:</strong> @(ExactStats.HitsStats.MeanHtoD.ToString("F1")) <span class="text-muted">(Â±@(ExactStats.HitsStats.StdDevHtoD.ToString("F1")))</span>
                        @if (DefenderElitesCommitted > 0)
                        {
                            <br /><span>ðŸŽ–ï¸ Elite Loss: @(ExactStats.DefenderEliteLossProbability.ToString("P1"))</span>
                        }
                    </div>
                </div>
                @if (ExactStats.StarResultProbability > 0 || ExactStats.AttackerLeaderDeathProbability > 0 || ExactStats.DefenderLeaderDeathProbability > 0)
                {
                    <hr class="my-2" />
                    <div class="small">
                        @if (ExactStats.StarResultProbability > 0)
                        {
                            <span class="me-2">â­ @(ExactStats.StarResultProbability.ToString("P1"))</span>
                        }
                        @if (ExactStats.AttackerLeaderDeathProbability > 0)
                        {
                            <span class="me-2">â˜ ï¸âš”ï¸ @(ExactStats.AttackerLeaderDeathProbability.ToString("P1"))</span>
                        }
                        @if (ExactStats.DefenderLeaderDeathProbability > 0)
                        {
                            <span>â˜ ï¸ðŸ›¡ï¸ @(ExactStats.DefenderLeaderDeathProbability.ToString("P1"))</span>
                        }
                    </div>
                }
                @* Compact distribution tables *@
                <hr class="my-2" />
                <div class="row">
                    <div class="col-12 col-md-6 mb-2">
                        <div class="small text-muted mb-1">âš”ï¸ Attacker Losses</div>
                        <div class="d-flex flex-wrap gap-1">
                            @foreach (var kvp in ExactStats.HitsStats.HitsToA_Prblty.OrderBy(x => x.Key))
                            {
                                <span class="badge dist-badge"><span class="dist-hits">@kvp.Key</span>: <span class="dist-prob">@(kvp.Value.ToString("P0"))</span></span>
                            }
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="small text-muted mb-1">ðŸ›¡ï¸ Defender Losses</div>
                        <div class="d-flex flex-wrap gap-1">
                            @foreach (var kvp in ExactStats.HitsStats.HitsToD_Prblty.OrderBy(x => x.Key))
                            {
                                <span class="badge dist-badge"><span class="dist-hits">@kvp.Key</span>: <span class="dist-prob">@(kvp.Value.ToString("P0"))</span></span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (MonteCarloResult != null)
    {
        <div class="card border-info mb-3">
            <div class="card-header bg-info text-white py-2">
                <strong>ðŸ“Š Monte Carlo (@MonteCarloResult.Value.trials.ToString("N0") trials)</strong>
            </div>
            <div class="card-body py-2">
                <div class="row g-2">
                    <div class="col-6">
                        <div class="d-flex justify-content-between small">
                            <span>âš”ï¸ Wins:</span>
                            <strong class="text-success">@(MonteCarloResult.Value.result.AttackerWinProbability.ToString("P1"))</strong>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex justify-content-between small">
                            <span>ðŸ›¡ï¸ Wins:</span>
                            <strong class="text-danger">@(MonteCarloResult.Value.result.DefenderWinProbability.ToString("P1"))</strong>
                        </div>
                    </div>
                </div>
                <div class="row small mt-1">
                    <div class="col-6">
                        <strong>âš”ï¸ Losses:</strong> @(MonteCarloResult.Value.result.HitsStats.MeanHtoA.ToString("F1"))
                        @if (AttackerElitesCommitted > 0)
                        {
                            <br /><span>ðŸŽ–ï¸ Elite Loss: @(MonteCarloResult.Value.result.AttackerEliteLossProbability.ToString("P1"))</span>
                        }
                    </div>
                    <div class="col-6">
                        <strong>ðŸ›¡ï¸ Losses:</strong> @(MonteCarloResult.Value.result.HitsStats.MeanHtoD.ToString("F1"))
                        @if (DefenderElitesCommitted > 0)
                        {
                            <br /><span>ðŸŽ–ï¸ Elite Loss: @(MonteCarloResult.Value.result.DefenderEliteLossProbability.ToString("P1"))</span>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    @if (BattleResult != null)
    {
        <div class="card @GetResultCardClass() mb-3">
            <div class="card-header py-2">
                <strong>ðŸŽ² Battle Result</strong>
            </div>
            <div class="card-body py-2">
                <div class="row">
                    <div class="col-6">
                        <p class="fs-5 fw-bold mb-1">
                            @if (BattleResult.Winner == Winner.Attacker)
                            {
                                <span class="text-success">ðŸ† Attacker!</span>
                            }
                            else
                            {
                                <span class="text-danger">ðŸ›¡ï¸ Defender!</span>
                            }
                        </p>
                        @if (BattleResult.Overrun)
                        {
                            <span class="badge bg-danger">Overrun!</span>
                        }
                        @if (BattleResult.Star)
                        {
                            <span class="badge bg-warning text-dark">â­ Star</span>
                        }
                    </div>
                    <div class="col-6 small">
                        <div>ðŸŽ² Atk: @BattleResult.AttackerDieRoll | Def: @BattleResult.DefenderDieRoll</div>
                        <div>
                            âš”ï¸ -@BattleResult.DamageToAttacker SP
                            @if (BattleResult.DamageToAttacker >= LastAttackerSize)
                            {
                                <span class="text-danger">(Wiped!)</span>
                            }
                            @if (BattleResult.AttackerEliteLoss)
                            {
                                <span class="badge bg-warning text-dark ms-1">ðŸŽ–ï¸ Elite Lost</span>
                            }
                        </div>
                        <div>
                            ðŸ›¡ï¸ -@BattleResult.DamageToDefender SP
                            @if (LastDefenderSize > 0 && BattleResult.DamageToDefender >= LastDefenderSize)
                            {
                                <span class="text-danger">(Wiped!)</span>
                            }
                            @if (BattleResult.DefenderEliteLoss)
                            {
                                <span class="badge bg-warning text-dark ms-1">ðŸŽ–ï¸ Elite Lost</span>
                            }
                        </div>
                    </div>
                </div>
                @if (BattleResult.AttackerLeaderDeathDieRoll.HasValue || BattleResult.DefenderLeaderDeathDieRoll.HasValue)
                {
                    <hr class="my-1" />
                    <div class="small">
                        @if (BattleResult.AttackerLeaderDeathDieRoll.HasValue)
                        {
                            <span class="me-2">
                                âš”ï¸ Leader: @(BattleResult.AttackerLeaderDeath ? "â˜ ï¸" : "âœ“") (ðŸŽ²@BattleResult.AttackerLeaderDeathDieRoll)
                            </span>
                        }
                        @if (BattleResult.DefenderLeaderDeathDieRoll.HasValue)
                        {
                            <span>
                                ðŸ›¡ï¸ Leader: @(BattleResult.DefenderLeaderDeath ? "â˜ ï¸" : "âœ“") (ðŸŽ²@BattleResult.DefenderLeaderDeathDieRoll)
                            </span>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@* Trials slider in a collapsible section *@
<details class="mt-3">
    <summary class="text-muted small">Monte Carlo Settings</summary>
    <div class="mt-2">
        <label class="form-label small">Trials: 2<sup>@TrialsExponent</sup> = @Trials.ToString("N0")</label>
        <input type="range" class="form-range" @bind="TrialsExponent" @bind:event="oninput" min="13" max="20" />
    </div>
</details>

@code {
    // Battle Location
    private bool ResourceOrCapital;
    private bool FortPresent;
    private bool IsInterception;
    private bool IsDefenderLeaderPresent;
    private bool IsAmphibious = false;

    // Attacker
    private int AttackerSize = 5;
    private int AttackerLeadersDRMIncludingCavalryIntelligence = 0;
    private int AttackerElitesCommitted = 0;
    private bool AttackerOOS;

    // Defender
    private int DefenderSize = 5;
    private int DefenderLeadersDRMIncludingCavalryIntelligence = 0;
    private int DefenderElitesCommitted = 0;
    private bool DefenderOOS;

    // Result
    private FTPBattleResult? BattleResult;

    // Monte Carlo
    private (int trials, FtpStats result)? MonteCarloResult;
    private bool IsRunning;
    private int TrialsExponent = 15; // 2^15 = 32,768 as default
    private int Trials => 1 << TrialsExponent; // 2^exponent

    // Exact Stats
    private FtpStats? ExactStats;

    // Store sizes at time of calculation for "Wiped Out!" display
    private int LastAttackerSize;
    private int LastDefenderSize;

    // Current battle for live calculations (e.g., IsOverrun check)
    private FtpBattle CurrentBattle => CreateBattle();

    private FtpBattle CreateBattle() => new FtpBattle(
        ResourceOrCapital,
        FortPresent,
        IsInterception,
        IsDefenderLeaderPresent,
        AttackerSize,
        DefenderSize,
        AttackerLeadersDRMIncludingCavalryIntelligence,
        DefenderLeadersDRMIncludingCavalryIntelligence,
        AttackerElitesCommitted,
        DefenderElitesCommitted,
        AttackerOOS,
        DefenderOOS,
        IsAmphibious);

    private async Task ScrollToResults()
    {
        await JS.InvokeVoidAsync("eval", "document.getElementById('resultsSection')?.scrollIntoView({behavior: 'smooth'})");
    }

    private async Task CalculateBattleResult()
    {
        LastAttackerSize = AttackerSize;
        LastDefenderSize = DefenderSize;
        BattleResult = CreateBattle().BattleResult(Dice.RollOneDieRepeatedly(4));
        await ScrollToResults();
    }

    private async Task RunMonteCarloTrials()
    {
        // Clear stale ExactStats when running MC
        ExactStats = null;

        IsRunning = true;
        StateHasChanged();

        FtpBattle battle = CreateBattle();
        MonteCarloResult = await Task.Run(() => FtpMonteCarlo.Run(battle, TrialsExponent));

        IsRunning = false;
        StateHasChanged();
        await ScrollToResults();
    }

    private async Task CalculateExactStats()
    {
        // Clear stale MonteCarloResult when calculating Exact
        MonteCarloResult = null;

        ExactStats = CreateBattle().ExactStats();
        await ScrollToResults();
    }

    private string GetResultCardClass()
    {
        if (BattleResult == null) return "";

        return BattleResult.Winner switch
        {
            Winner.Attacker => "border-success",
            Winner.Defender => "border-danger",
            _ => "border-warning"
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Select all text in number inputs on focus (helps mobile users)
            await JS.InvokeVoidAsync("eval", @"
                document.querySelectorAll('input[type=""number""]').forEach(input => {
                    input.addEventListener('focus', function() { this.select(); });
                });
            ");
        }
    }
}
